<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FridgeToFork - Video Analysis</title>
  <link rel="stylesheet" href="../assets/css/style.css" />
</head>

<body>

  <!-- Top Navigation Bar -->
  <nav class="top-nav">
    <div class="nav-left">
      <img src="../assets/images/pantry.svg" alt="FridgeToFork Logo" class="logo" />
      <span class="app-name">FridgeToFork</span>
    </div>
    <div class="nav-right">
      <a href="index.html">Home</a>
      <a href="video-analysis.html">Video Analysis</a>
      <a href="settings.html">Settings</a>
      <a href="about.html">About</a>
    </div>
  </nav>

  <div class="container">

    <div class="analysis-grid">

      <!-- LEFT: INPUT + HELP -->
      <div class="analysis-left">

        <div class="card" style="display:block;">
          <h1 style="margin-top:0;">Analyze a recipe video üé•</h1>
          <p class="subtitle" style="margin-bottom:10px;">
            Paste a recipe link and we‚Äôll tell you what you already have and what you need to buy.
          </p>

          <div class="section">
            <div class="section-title">Your saved pantry</div>
            <p style="color:#d6d6cc; margin-top:6px;">
              We‚Äôll compare the recipe against your pantry selection.
            </p>

            <div id="pantryPreview" class="chip-wrap" style="margin-top:10px;"></div>

            <a href="index.html" style="display:inline-block; margin-top:10px;">
              ‚Üê Update pantry
            </a>
          </div>

          <div class="section">
            <div class="section-title">Recipe video link</div>
            <input id="videoUrl" type="text" placeholder="Paste a YouTube recipe link..." />
            <button id="analyzeBtn">Analyze Video</button>
          </div>

          <!-- Loading -->
          <div id="loadingBox" class="loading-box" style="display:none;">
            <div class="spinner"></div>
            <div>
              <div style="font-weight:600;">Analyzing recipe‚Ä¶</div>
              <div style="font-size:14px; color:#c7c7bc;">
                This can take a few seconds.
              </div>
            </div>
          </div>

          <!-- Error -->
          <div id="errorBox" class="error-box" style="display:none;"></div>
        </div>

      </div>

      <!-- RIGHT: RESULTS -->
      <div class="analysis-right">

        <div id="resultsCard" class="card" style="display:none;">
          <div class="results-header">
            <div>
              <div class="results-title" id="dishName">Dish Name</div>
              <div class="results-sub" id="dishSubtitle">AI extracted ingredients</div>
            </div>
            <div class="badge" id="confidenceBadge">Confidence: --%</div>
          </div>

          <div class="results-split">

            <div class="results-block">
              <div class="section-title">You already have</div>
              <div id="haveList" class="chip-wrap"></div>
            </div>

            <div class="results-block">
              <div class="section-title">You need to buy</div>
              <div id="needList" class="chip-wrap"></div>
            </div>

          </div>

          <button id="copyBtn" class="secondary-btn">Copy shopping list</button>
        </div>

        <!-- Empty state -->
        <div id="emptyState" class="card" style="display:block;">
          <h1 style="margin-top:0;">Ready when you are üë®‚Äçüç≥</h1>
          <p class="subtitle">
            Paste a YouTube recipe link on the left, then hit ‚ÄúAnalyze Video‚Äù.
          </p>

          <div style="margin-top:12px; color:#d6d6cc;">
            Tip: Start with simple videos (short recipes, clear ingredients).
          </div>
        </div>

      </div>

    </div>

  </div>

  <script src="../assets/js/scripts.js"></script>

  <script>
    // ============================
    // UI Helpers
    // ============================
    function show(el) { el.style.display = "block"; }
    function hide(el) { el.style.display = "none"; }

    function setError(msg) {
      const box = document.getElementById("errorBox");
      box.textContent = msg;
      show(box);
    }

    function clearError() {
      hide(document.getElementById("errorBox"));
    }

    function renderChips(container, items, type = "neutral") {
      container.innerHTML = "";

      if (!items || items.length === 0) {
        const span = document.createElement("span");
        span.className = "chip chip-muted";
        span.textContent = "None found";
        container.appendChild(span);
        return;
      }

      items.forEach(i => {
        const chip = document.createElement("span");
        chip.className = `chip chip-${type}`;
        chip.textContent = i;
        container.appendChild(chip);
      });
    }

    // ============================
    // Pantry Preview
    // ============================
    const pantry = loadPantry();
    const pantryPreview = document.getElementById("pantryPreview");

    if (!pantry || pantry.length === 0) {
      renderChips(pantryPreview, ["No pantry selected yet"], "muted");
    } else {
      renderChips(pantryPreview, pantry.slice(0, 18), "neutral");

      if (pantry.length > 18) {
        const more = document.createElement("span");
        more.className = "chip chip-muted";
        more.textContent = `+${pantry.length - 18} more`;
        pantryPreview.appendChild(more);
      }
    }

    // ============================
    // Analyze Button
    // ============================
    const analyzeBtn = document.getElementById("analyzeBtn");
    const loadingBox = document.getElementById("loadingBox");
    const resultsCard = document.getElementById("resultsCard");
    const emptyState = document.getElementById("emptyState");

    analyzeBtn.addEventListener("click", async () => {
      clearError();

      const videoUrl = document.getElementById("videoUrl").value.trim();
      if (!videoUrl) {
        setError("Please paste a recipe video link first.");
        return;
      }

      // Show loading
      hide(resultsCard);
      show(emptyState);
      show(loadingBox);

      try {
        // IMPORTANT:
        // This calls your Flask /analyze endpoint.
        // If your backend isn't deployed yet, this will fail.
       const res = await fetch("https://cookable.onrender.com/analyze", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    video_url: videoUrl,
    pantry: pantry || []
  })
});

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || "Server error");
        }

        const result = data.result || data;

        if (result.error) {
          throw new Error(result.error);
        }

        // Fill results
        const dishName = document.getElementById("dishName");
        const dishSubtitle = document.getElementById("dishSubtitle");
        const confidenceBadge = document.getElementById("confidenceBadge");

        dishName.textContent = result.dish_name || "Unknown dish";
        dishSubtitle.textContent = "Ingredients extracted from the recipe video";

        const conf = typeof result.confidence === "number" ? result.confidence : null;
        confidenceBadge.textContent = conf !== null ? `Confidence: ${conf}%` : "Confidence: --%";

        renderChips(document.getElementById("haveList"), result.have || [], "have");
        renderChips(document.getElementById("needList"), result.need_to_buy || [], "need");

        // Show results
        hide(emptyState);
        show(resultsCard);

        // Copy button
        const copyBtn = document.getElementById("copyBtn");
        copyBtn.onclick = async () => {
          const need = result.need_to_buy || [];
          const dish = result.dish_name || "Recipe";

          const text = `Shopping list for: ${dish}\n\n` + need.map(x => `- ${x}`).join("\n");

          try {
            await navigator.clipboard.writeText(text);
            copyBtn.textContent = "Copied ‚úî";
            setTimeout(() => copyBtn.textContent = "Copy shopping list", 1400);
          } catch {
            copyBtn.textContent = "Copy failed";
            setTimeout(() => copyBtn.textContent = "Copy shopping list", 1400);
          }
        };

      } catch (err) {
        setError(
          "Error fetching analysis. Your AI backend may not be deployed yet.\n\n" +
          "Details: " + err.message
        );
      } finally {
        hide(loadingBox);
      }
    });
  </script>

</body>
</html>

